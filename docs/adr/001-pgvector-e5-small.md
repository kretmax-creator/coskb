# ADR-001: pgvector + multilingual-e5-small для семантического поиска

**Дата:** 24.02.2026
**Статус:** Принято

## Контекст

Проект Coskb — wiki-система (~100 статей на русском языке, тематика IT).
Встроенный полнотекстовый поиск Wiki.js (PostgreSQL FTS) не поддерживает поиск "по смыслу".
Требуется добавить семантический поиск как упражнение по разработке и для улучшения UX.

Ресурсы VM: 4 ядра (2.2 GHz), 8 GB RAM, 60 GB SAS.

## Рассмотренные варианты

### Вариант A: Elasticsearch

- Нативная интеграция с Wiki.js 2.x.
- Мощный полнотекстовый поиск, подсветка, фасеты.
- **Минусы:** +1 тяжёлый контейнер (~512MB–1GB RAM), не даёт семантического поиска "по смыслу" из коробки, потребовалось бы дополнительное решение для эмбеддингов.

### Вариант B: pgvector + multilingual-e5-small (выбран)

- pgvector — расширение для PostgreSQL, хранит и ищет векторы прямо в существующей БД.
- `intfloat/multilingual-e5-small` — компактная embedding-модель (~130MB), поддерживает русский язык, работает на CPU.
- **Минусы:** не встроен в Wiki.js UI (требуется отдельный API), нет нативной подсветки совпадений.

### Вариант C: Локальная генеративная LLM (Ollama)

- RAG: вопрос-ответ по базе знаний.
- **Минусы:** требует значительно больше ресурсов (GPU или 16+ GB RAM), избыточен для задачи поиска, сложнее в поддержке.

## Решение

Выбран **Вариант B: pgvector + multilingual-e5-small**.

**Обоснование:**
- Использует существующий PostgreSQL (замена образа `postgres:15` → `pgvector/pgvector:pg15`).
- Модель умещается в RAM и работает на CPU за секунды для 100 статей.
- Семантический поиск "по смыслу" — основная цель.
- Гибридный поиск (FTS + vector) закрывает оба сценария: точные совпадения и смысловой поиск.
- Минимальное усложнение инфраструктуры: +1 легковесный Python-контейнер.

## Последствия

- Образ PostgreSQL меняется на `pgvector/pgvector:pg15` (совместим с `postgres:15`).
- Добавляется Python-сервис `search-api` (отдельный контейнер).
- Схема `ai` в PostgreSQL для хранения эмбеддингов.
- Telegram-бот и будущие интеграции используют `search-api` как единую точку входа для поиска.
