# Vision

## 1. Назначение документа
Vision описывает целевую техническую архитектуру Coskb, принципы проектирования и границы MVP. Документ предназначен для архитектурного и технического ревью перед реализацией.

**Название проекта:** Coskb (рабочее название)

**Репозиторий:** https://github.com/kretmax-creator/coskb

## 2. Обзор системы
Coskb — монолитное wiki-приложение (Wiki.js), развёрнутое на Ubuntu Server VM с использованием Docker Compose. PostgreSQL — основное хранилище данных. Nginx — reverse proxy. 
Данные будут мигрированы из прототипа, развернутого на Kubernetes-кластере через pg_dump/restore.

## 3. Технологический стек (MVP)
*   **Wiki Engine:** Wiki.js 2.x (официальный Docker-образ `requarks/wiki:2`).
*   **Database:** PostgreSQL 15 (официальный Docker-образ `postgres:15`).
*   **Reverse Proxy:** Nginx 1.25 (официальный Docker-образ `nginx:1.25`).
*   **Orchestration:** Docker Compose.
*   **Container Runtime:** Docker Engine.
*   **Host OS:** Ubuntu Server.

**Future:** Python 3.11+, pgvector, Elasticsearch, LLM

## 4. Архитектурные принципы

### 4.1 Принципы MVP
- **Простота важнее гибкости.**
- **Явность вместо магии.**
- **Ручные операции допустимы.**

### 4.2 Осознанные архитектурные компромиссы
- Docker Compose вместо оркестраторов (K8s, Swarm).
- Ручное управление секретами (`.env` файл).
- Совместное использование одной БД для контента и будущих векторных данных.
- Ассеты (картинки) хранятся в БД.
- Offline-режим: на первом этапе без обновлений wikijs из интернета.

Все перечисленные решения применимы только для MVP и подлежат пересмотру при росте нагрузки или числа пользователей.

## 5. Структура проекта

### Repository layout
```text
/
├── docs/              # Документация
│   ├── vision.md      # Технический проект
│   └── tasklist.md    # План разработки
├── nginx/             # Конфигурация Nginx
│   └── default.conf   # Reverse proxy config
├── scripts/           # Скрипты автоматизации
│   ├── build.sh       # Скачивание образов (offline)
│   ├── load.sh        # Загрузка образов в Docker (offline)
│   ├── deploy.sh      # docker compose up
│   ├── stop.sh        # docker compose down
│   ├── backup_db.sh   # pg_dump
│   ├── restore_db.sh  # Восстановление дампа
│   └── status.sh      # Состояние контейнеров
├── data/              # Бэкапы и данные
│   └── backups/       # Дампы БД
├── docker-compose.yml # Описание стека
├── config.yml         # Wiki.js config (offline: true)
├── .env.example       # Шаблон переменных окружения
├── .gitignore
└── README.md          # Инструкция по запуску
```

### Runtime layout (Docker)
- Контейнеры: postgres, wikijs, nginx.
- Сеть: внутренняя Docker bridge network `coskb`.
- Данные PostgreSQL: host volume `/var/lib/coskb-data`.
- Nginx: порт 8890 → wikijs:3000.

## 6. Архитектура системы

### Компоненты (MVP)
1.  **Nginx**
    *   Reverse proxy. Единственная внешняя точка входа.
    *   Порт: 8890 на хосте → wikijs:3000 внутри сети.
2.  **Wiki.js**
    *   Stateless приложение. Хранит контент и ассеты через PostgreSQL.
    *   Режим: offline (`offline: true` в config.yml).
3.  **PostgreSQL**
    *   Stateful компонент. Единственный источник данных системы.
    *   **Физическое хранение:** host volume `/var/lib/coskb-data`.

## 7. Модель данных
*   **Wiki.js** — управляет своей схемой (страницы, пользователи, ассеты). Не проектируем таблицы вручную.
*   **Future (pgvector)** — отдельная схема/таблицы для векторных эмбеддингов статей.

## 8. Сценарии работы

### Первичная установка (миграция)
1.  Создать `.env` по шаблону `.env.example`.
2.  Подготовить директорию для данных БД (`/var/lib/coskb-data`).
3.  Загрузить Docker-образы (offline: `build.sh` → `load.sh`).
4.  Запустить стек: `deploy.sh`.
5.  Восстановить дамп: `restore_db.sh`.
6.  Wiki.js подхватывает существующие данные.

### Деплой (чистая установка)
1.  Создать `.env`.
2.  Запустить `deploy.sh` → Wiki.js открывает Setup Wizard.
3.  Пройти Setup Wizard, создать администратора.

### Нормальная работа (MVP)
1.  Пользователь заходит на `http://<host>:8890` → логинится → создаёт/редактирует статью → сохраняет.
2.  Поиск: полнотекстовый поиск через Wiki.js.

## 9. Конфигурирование
**Подход:** Все настройки передаются через переменные окружения (`.env` файл).

**Секреты:** Не хранятся в git. `.env` файл в `.gitignore`. Шаблон `.env.example` содержит только имена переменных.

## 10. Логгирование
**MVP-подход:** Приложения пишут в stdout/stderr. Логи доступны через `docker compose logs`.

**Формат:** Plain text.

## 11. Технический план (Roadmap)

### Этап 1 — MVP (Infrastructure + Migration)
- Развёртывание Wiki.js, PostgreSQL, Nginx на Docker.
- Миграция данных.
- Документированная процедура деплоя.

**Definition of Done:** Развёртывание по инструкции выполнено; данные восстановлены; Wiki.js работает; README содержит полную процедуру.

### Этап 2 — Контент (Future)
- Импорт новых данных.
- Формирование структуры базы знаний.

### Этап 3 — AI (Future)
- Добавление pgvector.
- Разработка внешнего AI-сервиса.
- Интеграция семантического поиска.
